#!/usr/bin/env bash
set -euo pipefail

STATE_FILE="${XDG_CACHE_HOME:-$HOME/.cache}/eww_playerctl_selected"
mkdir -p "$(dirname "$STATE_FILE")"

print_state() {
  local has_players="$1"  # true/false (unquoted in JSON)
  local icon="$2"
  local title="$3"
  local status_icon="$4"

  printf '{"has_players":%s,"icon":"%s","title":"%s","status_icon":"%s"}\n' \
    "$has_players" "$icon" "$title" "$status_icon"
}

print_no_player() {
  # "no media" state
  print_state false "󰓎" "" ""
}

map_icon() {
  local base="$1"
  case "$base" in
    spotify)                    printf '' ;;  # Spotify
    vlc)                        printf '󰕼' ;;  # VLC
    firefox|chromium|chrome|google-chrome|brave|vivaldi|opera|microsoft-edge)
                                printf '' ;;  # browser-ish
    *)                          printf '󰝚' ;;  # generic media
  esac
}

get_selected_player() {
  # 1) If user has manually selected a player and it still exists, use that
  if [[ -f "$STATE_FILE" ]]; then
    local sel
    sel="$(<"$STATE_FILE")"
    if [[ -n "$sel" ]] && playerctl -p "$sel" status >/dev/null 2>&1; then
      printf '%s\n' "$sel"
      return 0
    fi
  fi

  # 2) Prefer a player that is currently Playing
  local playing
  playing="$(playerctl -a metadata --format '{{playerName}} {{status}}' 2>/dev/null \
             | awk '$2=="Playing"{print $1; exit}' || true)"
  if [[ -n "${playing:-}" ]]; then
    printf '%s\n' "$playing"
    return 0
  fi

  # 3) Fallback: first available player
  playerctl -l 2>/dev/null | head -n 1 || true
}

while true; do
  players="$(playerctl -l 2>/dev/null || true)"
  if [[ -z "$players" ]]; then
    print_no_player
    sleep 2
    continue
  fi

  selected="$(get_selected_player || true)"
  if [[ -z "${selected:-}" ]]; then
    print_no_player
    sleep 2
    continue
  fi

  # Query metadata once per loop for the currently selected player
  metadata="$(playerctl -p "$selected" metadata \
               --format '{{playerName}}|{{status}}|{{title}}|{{artist}}' 2>/dev/null || true)"

  if [[ -z "$metadata" ]]; then
    print_no_player
    sleep 1
    continue
  fi

  IFS='|' read -r playerName status title artist <<<"$metadata"

  base="${playerName%%.*}"
  icon="$(map_icon "$base")"

  # Build title string
  if [[ -n "$artist" && -n "$title" ]]; then
    full_title="$artist - $title"
  elif [[ -n "$title" ]]; then
    full_title="$title"
  else
    full_title="$base"
  fi

  # Escape quotes for JSON
  full_title_escaped="${full_title//\"/\\\"}"

  # Status icon
  case "$status" in
    Playing) status_icon="" ;;  # show pause when playing
    Paused|Stopped|*) status_icon="" ;;
  esac

  print_state true "$icon" "$full_title_escaped" "$status_icon"

  sleep 1
done


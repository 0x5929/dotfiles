#!/usr/bin/env bash
set -euo pipefail

print_no_player() {
  # "no media" state
  printf '{"icon":"󰓎","title":"","status_icon":""}\n'
}

map_icon() {
  local base="$1"
  case "$base" in
    spotify)                    printf '' ;;  # Spotify
    vlc)                        printf '󰕼' ;;  # VLC
    firefox|chromium|chrome|google-chrome|brave|vivaldi|opera|microsoft-edge)
                                printf '' ;;  # browser-ish
    *)                          printf '󰝚' ;;  # generic media
  esac
}

while true; do
  # If no players, output "no player" periodically and keep trying
  if ! playerctl -l >/dev/null 2>&1; then
    print_no_player
    sleep 2
    continue
  fi

  # Follow *all* players; last one that fires wins (usually the one you’re actually using)
  playerctl --follow metadata --format '{{playerName}}|{{status}}|{{title}}|{{artist}}' 2>/dev/null | \
  while IFS='|' read -r playerName status title artist; do
    # If the command dies, break and restart outer loop
    [ -z "${playerName:-}" ] && break

    base="${playerName%%.*}"
    icon="$(map_icon "$base")"

    # Build title string
    if [[ -n "$artist" && -n "$title" ]]; then
      full_title="$artist - $title"
    elif [[ -n "$title" ]]; then
      full_title="$title"
    else
      full_title="$base"
    fi

    # Escaping for JSON
    full_title_escaped="${full_title//\"/\\\"}"

    # Status icon
    case "$status" in
      Playing) status_icon="" ;;  # show pause when playing
      Paused|Stopped|*) status_icon="" ;;
    esac

    printf '{"icon":"%s","title":"%s","status_icon":"%s"}\n' \
      "$icon" "$full_title_escaped" "$status_icon"
  done

  # If we fell out of the inner loop (player quit / error), try again
  print_no_player
  sleep 1
done


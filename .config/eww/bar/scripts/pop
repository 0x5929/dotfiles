#!/usr/bin/env bash
set -euo pipefail

EWW_BIN="/usr/bin/eww"
CFG_DIR="$HOME/.config/eww/bar"

eww_open() {
  "$EWW_BIN" -c "$CFG_DIR" open "$1"
}

eww_close() {
  # Be forgiving: don't kill the script if a window isn't open
  "$EWW_BIN" -c "$CFG_DIR" close "$@" 2>/dev/null || true
}

toggle_single() {
  # $1 = lock file, $2 = main window, rest = windows to close
  local lock="$1"
  local win="$2"
  shift 2
  local others=("$@")

  if [[ ! -f "$lock" ]]; then
    # First open: close others, set lock, open window
    if [[ ${#others[@]} -gt 0 ]]; then
      eww_close "${others[@]}"
    fi
    touch "$lock"
    eww_open "$win"
  else
    # Second click: close window, clear lock
    eww_close "$win"
    rm -f "$lock"
  fi
}

calendar() {
  toggle_single \
    "$HOME/.cache/eww-calendar.lock" \
    "calendar" \
    system system_b1 music_win music_win_b1 audio_ctl audio_ctl_b1 system_info system_info_b1
}

calendar_b1() {
  toggle_single \
    "$HOME/.cache/eww-calendar.lock" \
    "calendar_b1" \
    system system_b1 music_win music_win_b1 audio_ctl audio_ctl_b1 system_info system_info_b1
}

system() {
  toggle_single \
    "$HOME/.cache/eww-system.lock" \
    "system" \
    calendar calendar_b1 music_win music_win_b1 audio_ctl audio_ctl_b1 system_info system_info_b1
}

system_b1() {
  toggle_single \
    "$HOME/.cache/eww-system.lock" \
    "system_b1" \
    calendar calendar_b1 music_win music_win_b1 audio_ctl audio_ctl_b1 system_info system_info_b1
}

system_info() {
  toggle_single \
    "$HOME/.cache/eww-system-info.lock" \
    "system_info" \
    calendar calendar_b1 music_win music_win_b1 audio_ctl audio_ctl_b1 system system_b1
}

system_info_b1() {
  toggle_single \
    "$HOME/.cache/eww-system-info.lock" \
    "system_info_b1" \
    calendar calendar_b1 music_win music_win_b1 audio_ctl audio_ctl_b1 system system_b1
}

music() {
  toggle_single \
    "$HOME/.cache/eww-song.lock" \
    "music_win" \
    system system_b1 system_info system_info_b1 calendar calendar_b1 audio_ctl audio_ctl_b1
}

music_b1() {
  toggle_single \
    "$HOME/.cache/eww-song.lock" \
    "music_win_b1" \
    system system_b1 system_info system_info_b1 calendar calendar_b1 audio_ctl audio_ctl_b1
}

audio() {
  toggle_single \
    "$HOME/.cache/eww-audio.lock" \
    "audio_ctl" \
    system system_b1 calendar calendar_b1 music_win music_win_b1 system_info system_info_b1

  # Launch pavucontrol after toggling
  pavucontrol &
}

audio_b1() {
  toggle_single \
    "$HOME/.cache/eww-audio.lock" \
    "audio_ctl_b1" \
    system system_b1 calendar calendar_b1 music_win music_win_b1 system_info system_info_b1
}

case "${1-}" in
  calendar)        calendar ;;
  calendar_b1)     calendar_b1 ;;
  system)          system ;;
  system_b1)       system_b1 ;;
  system_info)     system_info ;;
  system_info_b1)  system_info_b1 ;;
  music)           music ;;
  music_b1)        music_b1 ;;
  audio)           audio ;;
  audio_b1)        audio_b1 ;;
  *)               exit 0 ;;
esac

